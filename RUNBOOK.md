# Deployment Runbook

This runbook explains how to run the application locally and how to deploy it to Azure using the provided infrastructure action.

## Running Locally

1. **Clone the repository**
   ```bash
   git clone <repository-url>
   cd Builder-vibe-landing
   ```

2. **Install Node.js and npm**
   Install the [Node Version Manager](https://github.com/nvm-sh/nvm) and then install Node 18:
   ```bash
   curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
   export NVM_DIR="$HOME/.nvm"
   [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
   nvm install 18
   ```

3. **Install dependencies**
   ```bash
   npm install
   ```

4. **Create a `.env.local` file**
   ```bash
   cp .env.example .env.local
   # Edit .env.local and provide real values for the placeholders
   ```

5. **Start the development server**
   ```bash
   npm run dev
   ```
   The app is available at [http://localhost:8080](http://localhost:8080).

6. **Optional: lint the project**
   ```bash
   npm run lint
   ```

7. **Build for production**
   ```bash
   npm run build
   ```
   The optimized site is written to the `dist/` directory.

## Deploying to Azure

The repository includes a composite GitHub Action located in `infra/actions/deploy` and a workflow `deploy-infra.yml` that provisions the required Azure resources.

### Prerequisites

1. **Install the Azure CLI**
   ```bash
   curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
   ```

2. **Sign in to Azure**
   ```bash
   az login
   ```

3. **Create a service principal for automation**
   ```bash
   az ad sp create-for-rbac \
     --name myapp-sp \
     --role contributor \
     --scopes /subscriptions/<subscription-id> \
     --sdk-auth > creds.json
   ```

4. **Add `AZURE_CREDENTIALS` GitHub secret**
   - Copy the contents of `creds.json` and add them as a repository secret named `AZURE_CREDENTIALS`.

5. **Ensure `.env.local` contains any connection strings or API endpoints** required by the app. Use the `.env.example` file as a template and keep your secrets out of source control.

### 1. Configure Secrets

Create a service principal and store the credentials in the `AZURE_CREDENTIALS` secret. Example:
```bash
az ad sp create-for-rbac --name myapp-sp --sdk-auth > creds.json
# Add the contents of creds.json to the AZURE_CREDENTIALS secret
```

### 2. Trigger the Workflow

Run the **Deploy Infrastructure** workflow from the GitHub Actions tab. It will:

1. Create the resource group
2. Provision an Azure Container Registry
3. Create an Azure Static Web App
4. Deploy a container instance for the backend
5. Set up PostgreSQL and Redis instances

You can adjust the resource names in `.github/workflows/deploy-infra.yml`.

### 3. Build and Deploy the Frontend

After infrastructure is ready, push commits to `main` that build the app and deploy to the Static Web App. The workflow generated by Azure will upload the contents of `dist/` after running `npm run build`.

### Manual Deployment (optional)

If you prefer the CLI, build locally and upload the assets using `az staticwebapp upload` as shown in **DEPLOY_AZURE.md**.

## Managing Secrets

Sensitive values such as database credentials or API keys should never be committed to version control.

1. **Local development**
   - Copy `.env.example` to `.env.local` and fill in your real secrets.
   - The Vite dev server automatically loads variables from `.env.local` so you can reference them with `import.meta.env` in the code.

2. **GitHub Actions**
   - Add the same variables as repository secrets (e.g. `DATABASE_URL`, `REDIS_URL`).
   - In workflows, export them to the environment or generate a `.env` file before running the build step:
     ```yaml
     - name: Create env file
       run: |
         echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env
         echo "REDIS_URL=${{ secrets.REDIS_URL }}" >> .env
     ```

3. **Azure**
   - Set the secrets as application settings on your Static Web App or Container Instance so they are injected as environment variables at runtime.


